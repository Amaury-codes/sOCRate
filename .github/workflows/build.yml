# .github/workflows/build.yml

name: Build sOCRate Application

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_macos:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install dependencies (Homebrew)
      run: |
        brew install tesseract tesseract-lang
    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    - name: Build macOS Application
      run: |
        TESSERACT_PATH=$(brew --prefix tesseract)
        pyinstaller socrate_app.py --noconfirm --onedir --windowed \
          --name "sOCRate" \
          --icon "assets/icon.icns" \
          --add-data "assets:assets" \
          --add-data "${TESSERACT_PATH}/bin:Tesseract-OCR/bin" \
          --add-data "${TESSERACT_PATH}/lib:Tesseract-OCR/lib" \
          --add-data "${TESSERACT_PATH}/share/tessdata:Tesseract-OCR/share/tessdata" \
          --osx-bundle-identifier "com.amaurypoussier.socrate" \
          --osx-entitlements-file "entitlements.plist"
    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: sOCRate-macOS
        path: dist/sOCRate.app

  build_windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Download and Install Tesseract for Windows
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri "https://github.com/UB-Mannheim/tesseract/releases/download/v5.3.3/tesseract-ocr-w64-setup-v5.3.3.20231005.exe" -OutFile "tesseract_setup.exe"
        Start-Process -FilePath ".\tesseract_setup.exe" -ArgumentList "/S" -Wait
    - name: Install Python packages
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    - name: Build Windows Application
      shell: pwsh
      run: |
        pyinstaller socrate_app.py --noconfirm --onedir --windowed `
          --name "sOCRate" `
          --icon "assets/icon.ico" `
          --add-data "assets;assets" `
          --add-data "C:\Program Files\Tesseract-OCR;Tesseract-OCR"
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: sOCRate-Windows
        path: dist/sOCRate